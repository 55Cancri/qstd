# qstd Development & Maintenance Guide

> **START HERE** if you're coming back to this project after a break

---

## üöÄ Quick Start: I Want to Add Something

### 1. Get Re-oriented (30 seconds)

```bash
cd qstd

# Check current version
cat package.json | grep version

# Verify build works
pnpm install
pnpm build

# ‚úÖ If build succeeds, you're ready!
```

### 2. Make Your Change (varies)

**Adding a new shared utility function:**

```bash
# Add to appropriate file in src/shared/
# Example: Adding List.map()
nano src/shared/list.ts

# Add your function:
export const map = <T, U>(xs: T[], fn: (x: T) => U): U[] => xs.map(fn);

# Test it compiles
pnpm build
```

**Adding a new client utility:**

```bash
# Add to src/client/dom.ts (or create new file)
nano src/client/dom.ts

# If new file, export from src/client/index.ts:
export * as NewModule from "./new-module";
```

**Adding a new React hook:**

```bash
# Add to src/react/index.ts
# Keep named exports only!
export function useMyHook() { /* ... */ }
```

**Updating Block component:**

```bash
# Files are in src/block/
# Main component: src/block/index.tsx
# Variants: src/block/accordion.tsx, drawer.tsx, etc.
```

### 3. Version & Publish (1 minute)

```bash
# Commit your changes
git add .
git commit -m "feat: add new utility function"

# Bump version (choose one):
pnpm version patch   # 0.1.0 ‚Üí 0.1.1 (bug fix)
pnpm version minor   # 0.1.0 ‚Üí 0.2.0 (new feature)
pnpm version major   # 0.1.0 ‚Üí 1.0.0 (breaking change)

# This auto-updates package.json and creates git tag

# Build & publish
pnpm build
pnpm publish --access public

# Push to GitHub
git push --follow-tags
```

### 4. Test in Your Project (2 minutes)

```bash
cd /path/to/your-project

# Update to latest
pnpm update qstd

# Or specific version
pnpm add qstd@0.1.1

# Verify it works
pnpm build
```

**Done!** ‚úÖ

---

## üìö Common Tasks

### Add a New Shared Utility

```bash
# 1. Edit the module file
nano src/shared/list.ts

# 2. Add function with JSDoc comment
/**
 * Map array to new array
 * @param xs
 * @param fn
 * @returns
 */
export const map = <T, U>(xs: T[], fn: (x: T) => U): U[] => xs.map(fn);

# 3. Build & verify
pnpm build

# 4. Publish (see versioning above)
```

### Add a New Hook

```bash
# 1. Edit src/react/index.ts
nano src/react/index.ts

# 2. Add hook (named export!)
export function useMyHook(value: string) {
  const [state, setState] = useState(value);
  return state;
}

# 3. Build & test
pnpm build
```

### Update Panda Preset

```bash
# 1. Edit panda.config.ts
nano panda.config.ts

# 2. Regenerate styled-system
pnpm panda codegen

# 3. Update src/preset/index.ts to match
nano src/preset/index.ts

# 4. Build
pnpm build
```

### Update Block Component

```bash
# Main component
nano src/block/index.tsx

# Or specific variant
nano src/block/accordion.tsx
nano src/block/drawer.tsx
# etc.

# Build
pnpm build
```

---

## üîç Package Structure Quick Reference

```
qstd/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ shared/       # List, Dict, Int, Money, Str, Time, Flow, Random
‚îÇ   ‚îú‚îÄ‚îÄ client/       # index.ts (re-exports shared), dom.ts
‚îÇ   ‚îú‚îÄ‚îÄ server/       # index.ts (re-exports shared), file.ts
‚îÇ   ‚îú‚îÄ‚îÄ react/        # index.ts (Block + hooks + types)
‚îÇ   ‚îú‚îÄ‚îÄ block/        # Block component files
‚îÇ   ‚îî‚îÄ‚îÄ preset/       # Panda preset
‚îÇ
‚îú‚îÄ‚îÄ tests/            # Test files (not published)
‚îú‚îÄ‚îÄ styled-system/    # Auto-generated by Panda (not published)
‚îî‚îÄ‚îÄ dist/             # Built output (published)
```

---

## ü§î FAQ

### Q: Which file do I edit to add a function to List?

**A:** `src/shared/list.ts`

Both client and server re-export it automatically via their `index.ts`.

### Q: How do I test my changes locally before publishing?

**A:** Two ways:

1. **Test utilities (no build needed):**

   ```bash
   # Test all utilities directly from source
   pnpm test:all
   # Or manually:
   pnpx tsx tests/test-all.ts
   ```

2. **Link to your project:**
   ```bash
   cd /path/to/your-project
   pnpm add /path/to/qstd
   # Test in your app
   ```

### Q: What version should I use?

**Patch** (0.1.0 ‚Üí 0.1.1):

- Bug fixes
- Typos in documentation
- Performance improvements (no API changes)

**Minor** (0.1.0 ‚Üí 0.2.0):

- New functions added (e.g., `List.map`)
- New hooks added (e.g., `useToggle`)
- New Panda CSS props/utilities (e.g., adding `autoCols`)
- Changing how existing Panda prop works WITHOUT changing signature
  - Example: `debug="blue"` produces slightly different shade
  - Code still works, just visual/behavior change

**Major** (0.1.0 ‚Üí 1.0.0):

- Removing functions (e.g., removing `List.chunk`)
- Changing function signatures (e.g., `clamp(num, range)` ‚Üí `clamp(num, min, max)`)
- Removing Panda CSS props (e.g., removing `alignC` utility)
- Drastically changing Panda prop syntax (e.g., `cols` now expects different format)
- Any change that would break existing consumer code

### Q: Do I need to update the PRD?

**A:** Only for major architectural changes. For adding individual functions, update:

- The function itself
- CHANGELOG.md
- README.md if it's a significant feature

### Q: I forgot how imports work

**A:**

```ts
// React stuff
import Block, { useDebounce, ImageFile } from "qstd/react";

// Browser
import * as Q from "qstd/client";
Q.List.create(10);

// Node.js
import * as Q from "qstd/server";
Q.File.readFile("file.txt");
```

### Q: How do I know if tree-shaking still works?

**A:**

```bash
cd tests
echo "import * as Q from 'qstd/client'; console.log(Q.List.create(5));" > test-tree.js
pnpx vite build test-tree.js
# Check bundle size - should only include List.create
```

### Q: Build failed - what do I do?

**A:**

```bash
# Check TypeScript errors
pnpx tsc --noEmit

# Check if styled-system needs regeneration
rm -rf styled-system
pnpm panda codegen

# Clean rebuild
rm -rf dist
pnpm build
```

### Q: How do I add a dependency?

**A:**

```bash
# Add to qstd
pnpm add some-package

# If it's only for Block component, add to external in tsup.config.ts
nano tsup.config.ts
# Add "some-package" to the external array
```

---

## üìã Pre-Publish Checklist

Before running `pnpm publish`:

- [ ] `pnpm build` succeeds
- [ ] `pnpx tsc --noEmit` passes
- [ ] Test utilities: `pnpm test:all`
- [ ] Test Block build: `pnpm test:block` (after build)
- [ ] CHANGELOG.md updated
- [ ] Version bumped (`pnpm version patch/minor/major`)
- [ ] Git committed
- [ ] Tested locally in your project (optional but recommended)

---

## üéØ Publishing Workflow

### First Time (Already Done)

```bash
pnpm login
pnpm whoami
```

### Every Update

```bash
# 1. Make changes
# 2. Update CHANGELOG.md
# 3. Commit
git add .
git commit -m "feat: add List.map function"

# 4. Version (auto-updates package.json)
pnpm version minor

# 5. Build
pnpm build

# 6. Publish
pnpm publish --access public

# 7. Push
git push --follow-tags
```

### Verify It Worked

```bash
pnpm view qstd

# In another project
pnpm add qstd@latest
```

---

## üõ†Ô∏è Troubleshooting

### "Module not found" in consumer

```bash
# Check package.json exports are correct
cat package.json | grep -A 20 exports

# Rebuild
pnpm build
```

### Types not working in consumer

```bash
# Verify .d.ts files exist
ls -lh dist/react/index.d.ts
ls -lh dist/client/index.d.ts

# Check if global types are in react types
grep "declare global" dist/react/index.d.ts
```

### Panda CSS not working

```bash
# Regenerate styled-system
pnpm panda codegen

# Rebuild
pnpm build

# In consumer project, update panda config:
# presets: [qstdPreset]
```

---

## üí° Tips

1. **Test locally first** - Use `pnpm add /path/to/qstd` in your project before publishing
2. **Use tests/** - Keep test files there, run with `pnpx tsx`
3. **Read SUMMARY.md** - Has complete function list
4. **Check READY.md** - Quick reference of current state
5. **Global types auto-apply** - No consumer import needed for ImageFile, etc.

---

## üéä You've Got This!

Remember:

- ‚úÖ Build first: `pnpm build`
- ‚úÖ Version: `pnpm version patch/minor/major`
- ‚úÖ Publish: `pnpm publish --access public`
- ‚úÖ Push: `git push --follow-tags`

That's it! 4 commands and you're done. üöÄ

---

## üé® Using qstd in a Consumer Project (Panda CSS Setup)

### Critical Requirements

**1. PostCSS Configuration** (REQUIRED):

```js
// postcss.config.cjs
module.exports = {
  plugins: {
    "@pandacss/dev/postcss": {},
  },
};
```

**Without this file:** Block components render but have NO STYLES!

**2. Panda Config with Base Preset and jsxFramework** (REQUIRED):

```ts
// panda.config.ts
import { defineConfig } from "@pandacss/dev";
import qstdPreset from "qstd/preset";

export default defineConfig({
  preflight: true,

  // CRITICAL: Must include base preset for default colors
  presets: ["@pandacss/dev/presets", qstdPreset],

  // Scan your source code
  include: ["./src/**/*.{ts,tsx}", "./pages/**/*.{js,jsx,ts,tsx}"],

  outdir: "styled-system",

  // REQUIRED: Enables Panda CSS to detect props on Block component
  // Without this, styles like bg="red" won't generate CSS utilities
  jsxFramework: "react",
});
```

**‚ö†Ô∏è CRITICAL:** The `jsxFramework: "react"` setting is **required** for the Block component to work. Without it, Panda CSS cannot detect style props like `bg="red"` on external components, and no CSS utilities will be generated.

**3. CSS File with Layers**:

```css
/* src/index.css */
@layer reset, base, tokens, recipes, utilities;

/* Your custom styles */
```

**4. Import CSS in main.tsx**:

```tsx
import "./index.css";
```

### Troubleshooting: Styles Not Applying

**Symptom:** Block components render, classes applied (like `bg_red`, `m_0`), but no visual styles

**Primary Cause:** Missing `jsxFramework: "react"` in panda.config.ts

**Fix:** Add `jsxFramework: "react"` to your Panda config and run `panda codegen`

**Secondary Cause:** PostCSS not configured

**Fix:** Ensure `postcss.config.cjs` exists with Panda plugin

**Verify it's working:**

```tsx
<Block bg="red" debug>
  Test
</Block>
```

Should show red background and debug border. If not:

1. Check `jsxFramework: "react"` is in panda.config.ts
2. Run `pnpm prepare` (or `panda codegen`) to regenerate
3. Restart dev server
4. Check PostCSS config exists
